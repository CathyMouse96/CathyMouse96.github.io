<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.ico">
    

    <title>
        
          CyberForce 2019 Recap - Cathy - CMouse&#39;s Blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
    <!-- Noto Sans SC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC" rel="stylesheet">
    <!-- Noto Sans -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/css/book.css">
    <script src="/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('img')
})
</script>

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/">CMouse&#39;s Blog</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-21">Anomaly 21</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
<li><a href="/cyberforce/anomaly-45">Anomaly 45</a></li>
<li><a href="/cyberforce/anomaly-49">Anomaly 49</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>

<script src="/js/book-sidebar.js"></script>

<script>
collapse_sidebar(2)
highlight_tab()
show_sidebar()
</script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/favicon.ico">
  </section>
  <section class="navbar-center">
    CMouse&#39;s Blog
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-21">Anomaly 21</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
<li><a href="/cyberforce/anomaly-45">Anomaly 45</a></li>
<li><a href="/cyberforce/anomaly-49">Anomaly 49</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="Cathy’s-Recap"><a href="#Cathy’s-Recap" class="headerlink" title="Cathy’s Recap"></a>Cathy’s Recap</h1><p>I’m writing this <del>because Dennis told me to</del> because I learned a lot through this experience and it would be meaningful to look back upon it someday. For this competition, we were each in charge of one machine, so I am mainly writing about the machine I was in charge of.</p>
<h1 id="System-overview"><a href="#System-overview" class="headerlink" title="System overview"></a>System overview</h1><p>The provided machine runs CentOS and hosts a website, which serves as the <strong>primary interface</strong> for users. The web engine is NGINX and the framework is Django (see next section for differences between web engines and frameworks). Ideally, users should be able to check their email, read and post engineering notes, access the HMI application and share files from this website.</p>
<p>In addition to the website, this machine also hosts a note-taking app, which is written in C and contains multiple vulnerabilities. I did not realize that we were <strong>not allowed to reimplement the functionalities</strong> with another language / framework, so I reimplemented the note-taking app with Django. Unfortunately, I later realized that this was forbidden, so we had to use the original app. Please don’t make my mistake next year!</p>
<p><img src="/images/cyberforce/recap_0.jpg" alt="Reimplemented note-taking app"></p>
<h1 id="Web-servers-and-web-frameworks"><a href="#Web-servers-and-web-frameworks" class="headerlink" title="Web servers and web frameworks"></a>Web servers and web frameworks</h1><p>First, let’s figure out the roles of NGINX and Django. NGINX is a web server. It took some Googling for me to figure out the difference between a web server (e.g. NGINX or Apache) and a web framework (e.g. Django or Flask).</p>
<p>Traditionally, web servers directly return <strong>static content</strong>, and communicate with application programs via Common Gateway Interface (CGI) to serve <strong>dynamic content</strong>.</p>
<p><img src="/images/cyberforce/recap_1.png" alt="CGI (Common Gateway Interface)"></p>
<p>Similarly, for Python applications or frameworks, Web Server Gateway Interface (WSGI) is used. The user communicates with NGINX server, which in turn communicates with the Django application to retrieve dynamic content.</p>
<p><img src="/images/cyberforce/recap_2.png" alt="WSGI (Web Server Gateway Interface)"></p>
<p>So this is the relationship between a web server and a web framework.</p>
<h1 id="Hardening-steps"><a href="#Hardening-steps" class="headerlink" title="Hardening steps"></a>Hardening steps</h1><p>Here are the hardening steps we took to secure this server.</p>
<h2 id="Adding-authentication"><a href="#Adding-authentication" class="headerlink" title="Adding authentication"></a>Adding authentication</h2><p>The provided website does not have any form of authentication. Anyone can use any functionality on the website! So the first thing I did was add user authentication. The tutorials on Django’s site are terrific. Just follow <a href="https://docs.djangoproject.com/en/2.2/topics/auth/" target="_blank" rel="noopener">this tutorial</a> and you’ve basically got everything.</p>
<p>Specifically, we added the <code>login_required</code> decorator to every view, added a view for logging in, modified the menu bar so clicking on “Files” wouldn’t open FTP directly, and added logout functionality.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mail</span><span class="params">(request)</span>:</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'ftpsrv'</span>: <span class="string">'10.0.%s.8'</span> % settings.TEAM</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'mail.html'</span>, context)</span><br></pre></td></tr></table></figure>
<h2 id="NGINX-Reverse-Proxy"><a href="#NGINX-Reverse-Proxy" class="headerlink" title="NGINX Reverse Proxy"></a>NGINX Reverse Proxy</h2><p>By default, our Django web application is running at <code>localhost:8000</code> and our <code>shellinabox</code> app is running at <code>localhost:8080</code>. We don’t want to expose the ports 8000 and 8080, but we also want users to be able to access these applications.</p>
<p>We can solve this problem by configuring NGINX to work as a reverse proxy. In the simplest case, the web server listens on an external port and proxies requests to different internal ports (on the <code>localhost</code> interface) based on the Uniform Resource Identifier (URI). We can configure our NGINX reverse proxy like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;  # Internal port for Django web app</span><br><span class="line">	server 127.0.0.1:8000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream shell &#123;  # Internal port for note-taking app</span><br><span class="line">        server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;  # External port</span><br><span class="line">	location / &#123;  # Proxy to Django web app</span><br><span class="line">		...</span><br><span class="line">		proxy_pass http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">	location /shell &#123;  # Proxy to note-taking app</span><br><span class="line">		...</span><br><span class="line">		proxy_pass http://shell;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As we can see, NGINX will be listening on port 80. Requests to /shell will be passed to the <code>shellinabox</code> app, and all other requests will be passed to the Django application.</p>
<h2 id="Self-signed-certificates"><a href="#Self-signed-certificates" class="headerlink" title="Self-signed certificates"></a>Self-signed certificates</h2><p>We know that HTTP isn’t safe because passwords are sent in plaintext. So we want to change our website to use HTTPS. This consists of three parts: <a href="https://docs.djangoproject.com/en/2.1/topics/security/#ssl-https" target="_blank" rel="noopener">making necessary changes in Django</a>, configuring NGINX to redirect traffic on port 80 to port 443 (see snippet below) and, most importantly, obtaining a certificate!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># This directive will redirect traffic to port 443.</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	listen [::]:80;</span><br><span class="line">	server_name web.cfc.cucyber.edu;</span><br><span class="line">        return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Real certificates cost money though, so why not sign one for ourselves? Not much to write about here though, since I mainly just followed these tutorials:</p>
<p><a href="https://deliciousbrains.com/ssl-certificate-authority-for-local-https-development/" target="_blank" rel="noopener">How to Create Your Own SSL Certificate Authority for Local HTTPS Development</a></p>
<p><a href="https://www.linode.com/docs/security/ssl/create-a-self-signed-tls-certificate/" target="_blank" rel="noopener">Create a Self-Signed TLS Certificate</a></p>
<h2 id="Deploying-Django"><a href="#Deploying-Django" class="headerlink" title="Deploying Django"></a>Deploying Django</h2><p>Django applications can run in two modes: development and deployment. Under development mode, helpful debug messages are printed, but secret keys are written in plaintext in the code. Before allowing access from the public, it is important to switch the application to deployment mode. This <a href="https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/" target="_blank" rel="noopener">Deployment checklist</a> provided on Django’s website can be very helpful.</p>
<p>The steps I took were:</p>
<ul>
<li>Put the secret key and database key in files (originally written in code; would be awful if you open-sourced the code!)</li>
<li>Set the <code>DEBUG</code> option in <code>settings.py</code> to <code>False</code></li>
<li>Restricted the allowed hosts in <code>settings.py</code></li>
<li>Created a root certificate and made HTTPS-related settings in Django and NGINX</li>
<li>Installed uWSGI (See <a href="https://docs.djangoproject.com/en/3.0/howto/deployment/wsgi/uwsgi/" target="_blank" rel="noopener">How to use Django with uWSGI</a> on Django’s website for more information)</li>
<li>Created uWSGI configuration file and started uWSGI</li>
<li>Changed related settings in NGINX configuration</li>
</ul>
<p>The web application is now deployed and running under HTTPS!</p>
<h2 id="Note-taking-app"><a href="#Note-taking-app" class="headerlink" title="Note-taking app"></a>Note-taking app</h2><p>Because I reimplemented the note-taking app with Django, I unfortunately did not have much time to look at the original app. The app was written in C and run as a service using <code>shellinabox</code> (GitHub repo <a href="https://github.com/shellinabox/shellinabox" target="_blank" rel="noopener">here</a>).</p>
<p>Aside from the vulnerabilities of the app itself, an issue with the note-taking app is that even with NGINX working as a reverse proxy, people can still bypass Django authentication by directly going to <code>https://web.cfc.cucyber.edu/shell</code>. This is because even though port 8080 is not visible externally, /shell will be proxied to localhost:8080. To deal with this issue, we added basic HTTP authentication to NGINX (see <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/" target="_blank" rel="noopener">NGINX Docs | Restricting Access with HTTP Basic Authentication</a> for how to do this). Now authentication is provided on both the NGINX level and the Django level, and any request to the server will not be served unless the user has been authenticated. I don’t know if there are safer and more elegant ways to solving this problem, but this solution provides basic protection.</p>
<h1 id="Other-stuff"><a href="#Other-stuff" class="headerlink" title="Other stuff"></a>Other stuff</h1><p>Aside from my tasks, I also learned a lot about securing a network in general. While I had heard about demilitarized zones - air gaps that separated the internal network from the external-facing interface - I’ve never used one or would have thought of applying one for our infrastructure. In this competition, we had a demilitarized zone between the DNS server, web server, mail server and HMI, which the users would have to have access to, and the Business Continuity server, Windows database server, Ansible Node (still have no idea what that is) and ICS device, which the users should only be able to access through the interfaces we provided. I learned that it could be unsafe to store the database on the same server as the website itself, so instead of using the default database on the same server as the Django application, I configured it to use the database on the Windows database server, which is behind the demilitarized zone. This experience really opened my eyes up to stuff that I otherwise would not have had contact with, and I’m really glad I had the opportunity to participate and learn from my teammates.</p>

</div>


  <div class="book-comments">
    




  </div>


<script src="/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>
