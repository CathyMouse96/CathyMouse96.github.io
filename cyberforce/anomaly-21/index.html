<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.ico">
    

    <title>
        
          Anomaly 21 - CMouse&#39;s Blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
    <!-- Noto Sans SC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC" rel="stylesheet">
    <!-- Noto Sans -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/css/book.css">
    <script src="/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('img')
})
</script>

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/">CMouse&#39;s Blog</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-21">Anomaly 21</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
<li><a href="/cyberforce/anomaly-45">Anomaly 45</a></li>
<li><a href="/cyberforce/anomaly-49">Anomaly 49</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>

<script src="/js/book-sidebar.js"></script>

<script>
collapse_sidebar(2)
highlight_tab()
show_sidebar()
</script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/favicon.ico">
  </section>
  <section class="navbar-center">
    CMouse&#39;s Blog
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li><a href="/">Home</a></li>
<li><a href="/picoctf/picoctf-2019">picoCTF 2019</a><ul>
<li><a href="/picoctf/whitepages">WhitePages</a></li>
<li><a href="/picoctf/c0rrupt">c0rrupt</a></li>
<li><a href="/picoctf/webnet0">WebNet0</a></li>
<li><a href="/picoctf/webnet1">WebNet1</a></li>
<li><a href="/picoctf/asm3">asm3</a></li>
<li><a href="/picoctf/asm4">asm4</a></li>
</ul>
</li>
<li><a href="/cyberforce/cyberforce-2019">CyberForce 2019</a><ul>
<li><a href="/cyberforce/cyberforce-2019-recap-cathy">Cathy’s Recap</a></li>
<li><a href="/cyberforce/anomaly-6">Anomaly 6</a></li>
<li><a href="/cyberforce/anomaly-21">Anomaly 21</a></li>
<li><a href="/cyberforce/anomaly-23">Anomaly 23</a></li>
<li><a href="/cyberforce/anomaly-45">Anomaly 45</a></li>
<li><a href="/cyberforce/anomaly-49">Anomaly 49</a></li>
</ul>
</li>
<li><a href="/uncategorized/weird-cs-doodles">Weird CS Doodles</a></li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="Anomaly-21-Shimo-La-Kumwagilia"><a href="#Anomaly-21-Shimo-La-Kumwagilia" class="headerlink" title="Anomaly 21: Shimo La Kumwagilia"></a>Anomaly 21: Shimo La Kumwagilia</h1><p>Points: Unknown</p>
<p>Your IDS system generated an alert for a known malicious IP, 40.122.151.219, that appears to be part of a <strong>watering hole attack</strong>. Examine the accompanying packet capture file (Anomaly 21.pcap) from the affected subnet to determine the cause of the suspicious activity. If this is a true positive, examine the associated traffic to determine whether the compromise was successful. To solve, look for the flag{\&lt;string>} value. To answer, submit only the \&lt;string> portion of the flag. For example, if I were to uncover the flag with value: flag{d41d8cd98f00b204e9800998ecf8427e} I would submit d41d8cd98f00b204e9800998ecf8427e for the answer.</p>
<hr>
<p>To solve this problem, we must first know what a <strong>watering hole attack</strong> is. The attacker tracks the websites that the victim frequents, scans those websites for vulnerabilities and injects malicious code into those websites to redirect the victim to the attacker’s server. The name comes from predators in the natural world, who lurk around watering holes, waiting to prey on animals that come to drink. [1]</p>
<p>The provided file is a packet capture. Since we know that 40.122.151.219 is the malicious IP, we can apply the filter “ip.addr == 40.122.151.219” to look at the packets coming from and going to the malicious server.</p>
<p><img src="/images/cyberforce/anomaly-21-1.jpeg" alt="Apply filter"></p>
<p>We can follow the TCP stream to see the conversation more easily:</p>
<p><img src="/images/cyberforce/anomaly-21-2.jpeg" alt="Follow TCP stream"></p>
<p>We can see that the attacker’s server responded with an HTML document. Plain old HTML isn’t interesting, but embedded JavaScript usually contains juicy stuff. In fact, if we scroll down a bit, we can see this script that looks suspicious:</p>
<p><img src="/images/cyberforce/anomaly-21-3.jpeg" alt="Suspicious JavaScript"></p>
<p>We can step through this code to figure out what it does. First, let’s copy the entire HTML document into a file, which we will call <code>bad_website.html</code>. Next, we can open the file in Google Chrome. Then, we can start debugging the code with Google Chrome’s Developer Tools.</p>
<p><img src="/images/cyberforce/anomaly-21-4.jpeg" alt="Debugging with Developer Tools"></p>
<p>We are interested in the script on line 122. Click on the pause button at the top-left of the rightmost panel to pause script execution. Then reload the page to pause execution at the beginning of the script. We can click on the little brackets at the bottom-left of the code panel, which will prettify the code and make it MUCH easier to read. Your screen should look like this:</p>
<p><img src="/images/cyberforce/anomaly-21-5.jpeg" alt="After pretty print"></p>
<p>We can then step through the code with the buttons at the top of the rightmost panel like with any other debugger. We can see the values of variables in the “Scope” tab of the rightmost panel. After stepping over the first line, we can see that <code>a</code> is an array of 7 strings (note that the scope of <code>a</code> is global):</p>
<p><img src="/images/cyberforce/anomaly-21-6.jpeg" alt="Value of variables"></p>
<p>Apparently, these strings are Base64-encoded. The decoded strings are:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RrODH</span><br><span class="line">SLjyK</span><br><span class="line">flag&#123;575e22bc356137a41abdef379b776dba&#125;</span><br><span class="line">check browser</span><br><span class="line">userAgent</span><br><span class="line">Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36</span><br><span class="line">exploit deployed</span><br></pre></td></tr></table></figure>
<p><strong><code>575e22bc356137a41abdef379b776dba</code> is the correct answer</strong>, but out of curiosity, we’ll step through the rest of the code to see what it’s doing.</p>
<p>The next 8 lines simply rearrange the order of the strings in array <code>a</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">c, d</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> e = <span class="function"><span class="keyword">function</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">while</span> (--f) &#123;</span><br><span class="line">			c[<span class="string">'push'</span>](c[<span class="string">'shift'</span>]());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	e(++d);</span><br><span class="line">&#125;(a, <span class="number">0x96</span>));</span><br></pre></td></tr></table></figure>
<p><code>c[&#39;shift&#39;]</code> pops out and returns the element at the front of the array, and <code>c[&#39;push&#39;]</code> pushes that element onto the end of the array. This process repeats for 0x96 times, so the resulting array is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">check browser</span><br><span class="line">userAgent</span><br><span class="line">Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36</span><br><span class="line">exploit deployed</span><br><span class="line">RrODH</span><br><span class="line">SLjyK</span><br><span class="line">flag&#123;575e22bc356137a41abdef379b776dba&#125;</span><br></pre></td></tr></table></figure>
<p>I won’t go into the details here, but function <code>b(x)</code> essentially returns the <code>x</code>th element of the rearranged array <code>a</code>. So function <code>e</code> returns <code>true</code> if the user agent is “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36”:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> f = b(<span class="string">'0x0'</span>);</span><br><span class="line">	<span class="keyword">if</span> (navigator[b(<span class="string">'0x1'</span>)] == b(<span class="string">'0x2'</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> !![];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Function <code>g</code> sets variable <code>h</code> to “exploit deployed” and always returns <code>true</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> h = b(<span class="string">'0x3'</span>);</span><br><span class="line">	<span class="keyword">return</span> !![];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Function <code>i</code> only alerts the flag if both <code>e()</code> and <code>g()</code> return <code>true</code>. Finally, function <code>i</code> is called:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (e() &amp;&amp; g()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (b(<span class="string">'0x4'</span>) === b(<span class="string">'0x5'</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> !![];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			alert(b(<span class="string">'0x6'</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">i();</span><br></pre></td></tr></table></figure>
<p>Thus we know that the flag is “575e22bc356137a41abdef379b776dba”, but the compromise was likely <strong>not</strong> successful, since we can see from the packet capture that the user agent is “Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393”, which does not match the target user agent.</p>
<p><strong>Trivia:</strong><br>“Shimo La Kumwagilia” means “watering the hole” in Swahili.</p>
<p><img src="/images/cyberforce/anomaly-21-simba.png" alt="Simba (Source [2])"></p>
<p><strong>References:</strong><br>[1] What is watering hole attack? - Definition from WhatIs.com, <a href="https://searchsecurity.techtarget.com/definition/watering-hole-attack" target="_blank" rel="noopener">https://searchsecurity.techtarget.com/definition/watering-hole-attack</a><br>[2] By Source (WP:NFCC#4), Fair use, <a href="https://en.wikipedia.org/w/index.php?curid=62188679" target="_blank" rel="noopener">https://en.wikipedia.org/w/index.php?curid=62188679</a></p>

</div>


  <div class="book-comments">
    




  </div>


<script src="/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>
